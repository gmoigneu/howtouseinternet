---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { getRelativeLocaleUrl } from 'astro:i18n';
import { t, getCategoryName, getTopicName } from '../../i18n/translations';

export function getStaticPaths() {
  return [
    { params: { locale: 'en' } },
    { params: { locale: 'fr' } },
    { params: { locale: 'es' } },
  ];
}

const { locale } = Astro.params;
const courses = await getCollection('courses');

// Build category -> topic -> courses structure
const structure = new Map<string, Map<string, string[]>>();

for (const course of courses) {
  const parts = course.id.split('/');
  if (parts.length < 4) continue;

  const [category, topic, courseSlug] = parts;

  if (!structure.has(category)) {
    structure.set(category, new Map());
  }
  const categoryTopics = structure.get(category)!;

  if (!categoryTopics.has(topic)) {
    categoryTopics.set(topic, []);
  }
  const topicCourses = categoryTopics.get(topic)!;

  if (!topicCourses.includes(courseSlug)) {
    topicCourses.push(courseSlug);
  }
}
---

<BaseLayout title={t(locale, 'home')}>
  <h1>{t(locale, 'siteTitle')}</h1>
  <p>{t(locale, 'siteDescription')}</p>

  {Array.from(structure.entries()).map(([category, topics]) => (
    <section>
      <h2><a href={getRelativeLocaleUrl(locale, `/${category}`)}>{getCategoryName(locale, category)}</a></h2>
      <ul>
        {Array.from(topics.entries()).map(([topic, topicCourses]) => (
          <li>
            <a href={getRelativeLocaleUrl(locale, `/${category}/${topic}`)}>{getTopicName(locale, topic)}</a>
            <span> ({topicCourses.length} {topicCourses.length === 1 ? t(locale, 'course') : t(locale, 'courses')})</span>
          </li>
        ))}
      </ul>
    </section>
  ))}
</BaseLayout>
