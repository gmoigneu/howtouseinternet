---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { getRelativeLocaleUrl } from 'astro:i18n';
import { t, getCategoryName, getTopicName } from '../../i18n/translations';

export function getStaticPaths() {
  return [
    { params: { locale: 'en' } },
    { params: { locale: 'fr' } },
    { params: { locale: 'es' } },
  ];
}

const { locale } = Astro.params;
const courses = await getCollection('courses');

// Build category -> topic -> courses structure
const structure = new Map<string, Map<string, string[]>>();

for (const course of courses) {
  const parts = course.id.split('/');
  if (parts.length < 4) continue;

  const [category, topic, courseSlug] = parts;

  if (!structure.has(category)) {
    structure.set(category, new Map());
  }
  const categoryTopics = structure.get(category)!;

  if (!categoryTopics.has(topic)) {
    categoryTopics.set(topic, []);
  }
  const topicCourses = categoryTopics.get(topic)!;

  if (!topicCourses.includes(courseSlug)) {
    topicCourses.push(courseSlug);
  }
}
---

<BaseLayout title={t(locale, 'home')}>
  <div class="max-w-[680px]">
    <h1 class="font-serif text-4xl font-normal leading-tight mb-6">
      {t(locale, 'siteTitle')}
    </h1>
    <p class="text-lg text-text-muted mb-12">
      {t(locale, 'siteDescription')}
    </p>

    <div class="space-y-12">
      {Array.from(structure.entries()).map(([category, topics]) => (
        <section>
          <h2 class="font-serif text-3xl font-normal mb-6">
            <a
              href={getRelativeLocaleUrl(locale, `/${category}`)}
              class="text-text no-underline hover:underline"
            >
              {getCategoryName(locale, category)}
            </a>
          </h2>
          <ul class="space-y-3 list-none pl-0">
            {Array.from(topics.entries()).map(([topic, topicCourses]) => (
              <li class="flex items-baseline gap-2">
                <a
                  href={getRelativeLocaleUrl(locale, `/${category}/${topic}`)}
                  class="nav-link text-sm"
                >
                  {getTopicName(locale, topic)}
                </a>
                <span class="text-xs text-text-subtle">
                  ({topicCourses.length} {topicCourses.length === 1 ? t(locale, 'course') : t(locale, 'courses')})
                </span>
              </li>
            ))}
          </ul>
        </section>
      ))}
    </div>
  </div>
</BaseLayout>
