---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { getRelativeLocaleUrl } from 'astro:i18n';
import { t, getCategoryName, getTopicName } from '../../i18n/translations';

export function getStaticPaths() {
  return [
    { params: { locale: 'en' } },
    { params: { locale: 'fr' } },
    { params: { locale: 'es' } },
  ];
}

const { locale } = Astro.params;
const courses = await getCollection('courses');

// Build category -> topic -> courses structure
const structure = new Map<string, Map<string, string[]>>();

for (const course of courses) {
  const parts = course.id.split('/');
  if (parts.length < 4) continue;

  const [category, topic, courseSlug] = parts;

  if (!structure.has(category)) {
    structure.set(category, new Map());
  }
  const categoryTopics = structure.get(category)!;

  if (!categoryTopics.has(topic)) {
    categoryTopics.set(topic, []);
  }
  const topicCourses = categoryTopics.get(topic)!;

  if (!topicCourses.includes(courseSlug)) {
    topicCourses.push(courseSlug);
  }
}

// Category icons mapping
const categoryIcons: Record<string, string> = {
  'stay-safe-online': 'ğŸ›¡ï¸',
  'internet-technologies': 'ğŸŒ',
  'artificial-intelligence': 'ğŸ¤–',
};

// Helper to get category stats
function getCategoryStats(topics: Map<string, string[]>) {
  const topicCount = topics.size;
  const courseCount = Array.from(topics.values()).reduce((sum, courses) => sum + courses.length, 0);
  return { topicCount, courseCount };
}
---

<BaseLayout title={t(locale, 'home')}>
  <div class="max-w-4xl">
    <!-- Hero Section -->
    <header class="mb-16">
      <h1 class="font-serif text-4xl font-bold leading-tight mb-6">
        {t(locale, 'heroTitle')}
      </h1>
      <p class="text-xl text-text-muted leading-relaxed mb-8">
        {t(locale, 'heroDescription')}
      </p>
    </header>

    <!-- Values Section -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-16">
      <div class="p-6 bg-surface rounded-lg">
        <div class="text-2xl mb-3" aria-hidden="true">ğŸ¯</div>
        <h2 class="font-sans text-lg font-semibold mb-2">{t(locale, 'missionTitle')}</h2>
        <p class="text-sm text-text-muted leading-relaxed">{t(locale, 'missionDescription')}</p>
      </div>
      <div class="p-6 bg-surface rounded-lg">
        <div class="text-2xl mb-3" aria-hidden="true">ğŸ“–</div>
        <h2 class="font-sans text-lg font-semibold mb-2">{t(locale, 'openSourceTitle')}</h2>
        <p class="text-sm text-text-muted leading-relaxed">{t(locale, 'openSourceDescription')}</p>
      </div>
      <div class="p-6 bg-surface rounded-lg">
        <div class="text-2xl mb-3" aria-hidden="true">ğŸ‘¥</div>
        <h2 class="font-sans text-lg font-semibold mb-2">{t(locale, 'forEveryoneTitle')}</h2>
        <p class="text-sm text-text-muted leading-relaxed">{t(locale, 'forEveryoneDescription')}</p>
      </div>
    </section>

    <!-- Courses Section -->
    <section>
      <h2 class="text-sm font-semibold uppercase tracking-wide text-text-muted mb-6">{t(locale, 'exploreCourses')}</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        {Array.from(structure.entries()).map(([category, topics]) => {
          const stats = getCategoryStats(topics);
          return (
            <a
              href={getRelativeLocaleUrl(locale, `/${category}`)}
              class="group block p-6 bg-surface rounded-lg border border-border hover:border-text-muted transition-colors"
            >
              <div class="flex items-start gap-4">
                <span class="text-2xl" aria-hidden="true">
                  {categoryIcons[category] || 'ğŸ“š'}
                </span>
                <div class="flex-1 min-w-0">
                  <h3 class="font-sans text-lg font-semibold text-text group-hover:text-black mb-1">
                    {getCategoryName(locale, category)}
                  </h3>
                  <p class="text-sm text-text-muted mb-3">
                    {stats.topicCount} {t(locale, 'topics').toLowerCase()} Â· {stats.courseCount} {stats.courseCount === 1 ? t(locale, 'course') : t(locale, 'courses')}
                  </p>
                  <ul class="space-y-1 list-none pl-0">
                    {Array.from(topics.entries()).slice(0, 3).map(([topic]) => (
                      <li class="text-xs text-text-subtle">
                        {getTopicName(locale, topic)}
                      </li>
                    ))}
                    {topics.size > 3 && (
                      <li class="text-xs text-text-subtle">+{topics.size - 3} more...</li>
                    )}
                  </ul>
                </div>
                <svg
                  class="w-5 h-5 text-text-subtle group-hover:text-text-muted transition-colors flex-shrink-0 mt-1"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  aria-hidden="true"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </div>
            </a>
          );
        })}
      </div>
    </section>
  </div>
</BaseLayout>
