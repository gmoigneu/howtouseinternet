---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { getRelativeLocaleUrl } from 'astro:i18n';

export async function getStaticPaths() {
  const courses = await getCollection('courses');

  const topics = new Map<string, { category: string; topic: string; courses: Array<{ slug: string; title: string }> }>();

  for (const course of courses) {
    const parts = course.id.split('/');
    if (parts.length < 4) continue;

    const [category, topic, courseSlug, courseLocale] = parts;

    // Only use English courses for the listing (as fallback titles)
    if (courseLocale !== 'en') continue;

    const key = `${category}/${topic}`;

    if (!topics.has(key)) {
      topics.set(key, { category, topic, courses: [] });
    }

    const topicData = topics.get(key)!;
    topicData.courses.push({ slug: courseSlug, title: course.data.title });
  }

  const paths = [];
  for (const locale of ['en', 'fr', 'es']) {
    for (const { category, topic, courses } of topics.values()) {
      paths.push({
        params: { locale, category, topic },
        props: { category, topic, courses },
      });
    }
  }

  return paths;
}

interface Props {
  category: string;
  topic: string;
  courses: Array<{ slug: string; title: string }>;
}

const { locale } = Astro.params;
const { category, topic, courses } = Astro.props;
---

<BaseLayout title={topic}>
  <h1>{topic}</h1>

  <p><a href={getRelativeLocaleUrl(locale, `/${category}`)}>‚Üê Back to {category}</a></p>

  <h2>Courses</h2>
  <ul>
    {courses.map((course) => (
      <li>
        <a href={getRelativeLocaleUrl(locale, `/${category}/${topic}/${course.slug}`)}>{course.title}</a>
      </li>
    ))}
  </ul>
</BaseLayout>
