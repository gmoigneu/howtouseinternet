---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { getRelativeLocaleUrl } from 'astro:i18n';
import { t, getCategoryName, getTopicName } from '../../../../i18n/translations';

export async function getStaticPaths() {
  const allCourses = await getCollection('courses');

  // Group courses by category/topic and locale
  const topicsMap = new Map<string, {
    category: string;
    topic: string;
    coursesByLocale: Map<string, Array<{ slug: string; title: string }>>;
  }>();

  for (const course of allCourses) {
    const parts = course.id.split('/');
    if (parts.length < 4) continue;

    const [category, topic, courseSlug, courseLocale] = parts;
    const key = `${category}/${topic}`;

    if (!topicsMap.has(key)) {
      topicsMap.set(key, { category, topic, coursesByLocale: new Map() });
    }

    const topicData = topicsMap.get(key)!;
    if (!topicData.coursesByLocale.has(courseLocale)) {
      topicData.coursesByLocale.set(courseLocale, []);
    }
    topicData.coursesByLocale.get(courseLocale)!.push({ slug: courseSlug, title: course.data.title });
  }

  const paths = [];
  for (const locale of ['en', 'fr', 'es']) {
    for (const { category, topic, coursesByLocale } of topicsMap.values()) {
      // Use locale-specific titles if available, fallback to English
      const courses = coursesByLocale.get(locale) || coursesByLocale.get('en') || [];
      paths.push({
        params: { locale, category, topic },
        props: { category, topic, courses },
      });
    }
  }

  return paths;
}

interface Props {
  category: string;
  topic: string;
  courses: Array<{ slug: string; title: string }>;
}

const { locale } = Astro.params;
const { category, topic, courses } = Astro.props;
const categoryName = getCategoryName(locale, category);
const topicName = getTopicName(locale, topic);
---

<BaseLayout title={topicName}>
  <div class="max-w-[680px]">
    <p class="mb-8">
      <a href={getRelativeLocaleUrl(locale, `/${category}`)} class="nav-link">
        {t(locale, 'backTo')} {categoryName}
      </a>
    </p>

    <h1 class="font-serif text-4xl font-bold leading-tight mb-8">
      {topicName}
    </h1>

    <section>
      <h2 class="nav-link nav-link-active mb-6">{t(locale, 'courses')}</h2>
      <ul class="space-y-4 list-none pl-0">
        {courses.map((course) => (
          <li>
            <a
              href={getRelativeLocaleUrl(locale, `/${category}/${topic}/${course.slug}`)}
              class="text-text underline hover:text-black"
            >
              {course.title}
            </a>
          </li>
        ))}
      </ul>
    </section>
  </div>
</BaseLayout>
