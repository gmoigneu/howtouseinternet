---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';
import { getRelativeLocaleUrl } from 'astro:i18n';
import { t, getTopicName, getDifficultyLabel, getReadingTime } from '../../../../i18n/translations';

export async function getStaticPaths() {
  const courses = await getCollection('courses');

  // Group courses by category/topic/courseSlug
  const courseMap = new Map<string, Map<string, typeof courses[number]>>();

  for (const course of courses) {
    const parts = course.id.split('/');
    if (parts.length < 4) continue;

    const [category, topic, courseSlug, courseLocale] = parts;
    const key = `${category}/${topic}/${courseSlug}`;

    if (!courseMap.has(key)) {
      courseMap.set(key, new Map());
    }
    courseMap.get(key)!.set(courseLocale, course);
  }

  const paths = [];
  for (const [key, localeVersions] of courseMap.entries()) {
    const [category, topic, courseSlug] = key.split('/');

    for (const locale of ['en', 'fr', 'es']) {
      // Get the course in the requested locale, fallback to English
      const course = localeVersions.get(locale) || localeVersions.get('en');
      if (!course) continue;

      const availableLocales = Array.from(localeVersions.keys());

      paths.push({
        params: { locale, category, topic, course: courseSlug },
        props: {
          category,
          topic,
          courseSlug,
          course,
          availableLocales,
          isTranslated: localeVersions.has(locale),
        },
      });
    }
  }

  return paths;
}

interface Props {
  category: string;
  topic: string;
  courseSlug: string;
  course: Awaited<ReturnType<typeof getCollection>>[number];
  availableLocales: string[];
  isTranslated: boolean;
}

const { locale } = Astro.params;
const { category, topic, courseSlug, course, availableLocales, isTranslated } = Astro.props;
const { Content, headings } = await render(course);
const topicName = getTopicName(locale, topic);

// Get chapter headings (h2)
const chapters = headings.filter(h => h.depth === 2);

// Build the path to the markdown file for GitHub edit link
const githubEditPath = `src/content/courses/${course.id}.md`;
---

<BaseLayout title={course.data.title} sidebar={true} githubEditPath={githubEditPath}>
  <aside slot="sidebar" class="hidden lg:block">
    <div class="sticky top-8">
      <p class="mb-6">
        <a href={getRelativeLocaleUrl(locale, `/${category}/${topic}`)} class="nav-link">
          {t(locale, 'backTo')} {topicName}
        </a>
      </p>

      {chapters.length > 0 && (
        <nav aria-label="Table of contents">
          <h2 class="nav-link nav-link-active mb-4">{t(locale, 'chapters')}</h2>
          <ol class="list-none pl-0 space-y-2">
            {chapters.map((chapter, index) => (
              <li>
                <a href={`#${chapter.slug}`} class="font-sans text-xs text-text-subtle hover:text-text no-underline">
                  {index + 1}. {chapter.text}
                </a>
              </li>
            ))}
          </ol>
        </nav>
      )}
    </div>
  </aside>

  <article class="prose">
    <p class="lg:hidden mb-8">
      <a href={getRelativeLocaleUrl(locale, `/${category}/${topic}`)} class="nav-link">
        {t(locale, 'backTo')} {topicName}
      </a>
    </p>

    <header class="mb-12">
      <h1>{course.data.title}</h1>
      <p class="text-lg text-text-muted">{course.data.description}</p>

      <div class="flex flex-wrap items-center gap-4 text-sm text-text-muted my-6">
        <span class="inline-flex items-center gap-1.5">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
          </svg>
          {getReadingTime(locale, course.data.readingTime)}
        </span>
        <span class="inline-flex items-center gap-1.5">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
          </svg>
          {getDifficultyLabel(locale, course.data.difficulty)}
        </span>
      </div>

      {!isTranslated && (
        <p class="text-sm text-text-subtle italic border-l-2 border-border pl-4 my-6">
          {t(locale, 'notTranslated')}
        </p>
      )}

      {course.data.objectives && course.data.objectives.length > 0 && (
        <section class="bg-surface p-6 rounded-lg my-8" aria-labelledby="objectives-heading">
          <h2 id="objectives-heading" class="font-sans text-base font-semibold mt-0 mb-4">{t(locale, 'whatYoullLearn')}</h2>
          <ul class="list-none pl-0 space-y-2 mb-0">
            {course.data.objectives.map((objective) => (
              <li class="flex items-start gap-2 mb-0">
                <span class="text-text-muted" aria-hidden="true">-</span>
                <span>{objective}</span>
              </li>
            ))}
          </ul>
        </section>
      )}

      {chapters.length > 0 && (
        <nav class="lg:hidden border border-border p-6 rounded-lg my-8" aria-label="Table of contents">
          <h2 class="font-sans text-base font-semibold mt-0 mb-4">{t(locale, 'chapters')}</h2>
          <ol class="list-none pl-0 space-y-2 mb-0">
            {chapters.map((chapter, index) => (
              <li class="mb-0">
                <a href={`#${chapter.slug}`} class="font-sans text-xs text-text-subtle hover:text-text no-underline">
                  {index + 1}. {chapter.text}
                </a>
              </li>
            ))}
          </ol>
        </nav>
      )}
    </header>

    <Content />

    <footer class="mt-16 pt-8 border-t border-border">
      <dl class="text-sm text-text-muted space-y-1">
        <div class="flex gap-2">
          <dt class="font-medium">{t(locale, 'author')}:</dt>
          <dd>{course.data.author}</dd>
        </div>
        <div class="flex gap-2">
          <dt class="font-medium">{t(locale, 'lastUpdated')}:</dt>
          <dd>{course.data.updated_at.toLocaleDateString(locale)}</dd>
        </div>
      </dl>
    </footer>
  </article>
</BaseLayout>
