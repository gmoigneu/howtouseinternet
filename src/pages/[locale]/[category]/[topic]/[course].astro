---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';
import { getRelativeLocaleUrl } from 'astro:i18n';
import { t, getTopicName } from '../../../../i18n/translations';

export async function getStaticPaths() {
  const courses = await getCollection('courses');

  // Group courses by category/topic/courseSlug
  const courseMap = new Map<string, Map<string, typeof courses[number]>>();

  for (const course of courses) {
    const parts = course.id.split('/');
    if (parts.length < 4) continue;

    const [category, topic, courseSlug, courseLocale] = parts;
    const key = `${category}/${topic}/${courseSlug}`;

    if (!courseMap.has(key)) {
      courseMap.set(key, new Map());
    }
    courseMap.get(key)!.set(courseLocale, course);
  }

  const paths = [];
  for (const [key, localeVersions] of courseMap.entries()) {
    const [category, topic, courseSlug] = key.split('/');

    for (const locale of ['en', 'fr', 'es']) {
      // Get the course in the requested locale, fallback to English
      const course = localeVersions.get(locale) || localeVersions.get('en');
      if (!course) continue;

      const availableLocales = Array.from(localeVersions.keys());

      paths.push({
        params: { locale, category, topic, course: courseSlug },
        props: {
          category,
          topic,
          courseSlug,
          course,
          availableLocales,
          isTranslated: localeVersions.has(locale),
        },
      });
    }
  }

  return paths;
}

interface Props {
  category: string;
  topic: string;
  courseSlug: string;
  course: Awaited<ReturnType<typeof getCollection>>[number];
  availableLocales: string[];
  isTranslated: boolean;
}

const { locale } = Astro.params;
const { category, topic, courseSlug, course, availableLocales, isTranslated } = Astro.props;
const { Content, headings } = await render(course);
const topicName = getTopicName(locale, topic);

// Get chapter headings (h2)
const chapters = headings.filter(h => h.depth === 2);
---

<BaseLayout title={course.data.title}>
  <p><a href={getRelativeLocaleUrl(locale, `/${category}/${topic}`)}>{t(locale, 'backTo')} {topicName}</a></p>

  <article>
    <header>
      <h1>{course.data.title}</h1>
      <p>{course.data.description}</p>

      {!isTranslated && (
        <p><em>{t(locale, 'notTranslated')}</em></p>
      )}

      {course.data.objectives && course.data.objectives.length > 0 && (
        <section>
          <h2>{t(locale, 'whatYoullLearn')}</h2>
          <ul>
            {course.data.objectives.map((objective) => (
              <li>{objective}</li>
            ))}
          </ul>
        </section>
      )}

      {chapters.length > 0 && (
        <nav>
          <h2>{t(locale, 'chapters')}</h2>
          <ol>
            {chapters.map((chapter) => (
              <li><a href={`#${chapter.slug}`}>{chapter.text}</a></li>
            ))}
          </ol>
        </nav>
      )}
    </header>

    <Content />

    <footer>
      <p>{t(locale, 'author')}: {course.data.author}</p>
      <p>{t(locale, 'lastUpdated')}: {course.data.updated_at.toLocaleDateString(locale)}</p>
    </footer>
  </article>
</BaseLayout>
