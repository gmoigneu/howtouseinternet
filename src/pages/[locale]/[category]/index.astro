---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { getRelativeLocaleUrl } from 'astro:i18n';
import { t, getCategoryName, getTopicName } from '../../../i18n/translations';

export async function getStaticPaths() {
  const courses = await getCollection('courses');

  const categories = new Map<string, Map<string, string[]>>();

  for (const course of courses) {
    const parts = course.id.split('/');
    if (parts.length < 4) continue;

    const [category, topic, courseSlug] = parts;

    if (!categories.has(category)) {
      categories.set(category, new Map());
    }
    const categoryTopics = categories.get(category)!;

    if (!categoryTopics.has(topic)) {
      categoryTopics.set(topic, []);
    }
    const topicCourses = categoryTopics.get(topic)!;

    if (!topicCourses.includes(courseSlug)) {
      topicCourses.push(courseSlug);
    }
  }

  const paths = [];
  for (const locale of ['en', 'fr', 'es']) {
    for (const [category, topics] of categories.entries()) {
      paths.push({
        params: { locale, category },
        props: { category, topics },
      });
    }
  }

  return paths;
}

interface Props {
  category: string;
  topics: Map<string, string[]>;
}

const { locale } = Astro.params;
const { category, topics } = Astro.props;
const categoryName = getCategoryName(locale, category);
---

<BaseLayout title={categoryName}>
  <div class="max-w-[680px]">
    <p class="mb-8">
      <a href={getRelativeLocaleUrl(locale, '/')} class="nav-link">
        {t(locale, 'backToHome')}
      </a>
    </p>

    <h1 class="font-serif text-4xl font-bold leading-tight mb-8">
      {categoryName}
    </h1>

    <section>
      <h2 class="nav-link nav-link-active mb-6">{t(locale, 'topics')}</h2>
      <ul class="space-y-3 list-none pl-0">
        {Array.from(topics.entries()).map(([topic, topicCourses]) => (
          <li class="flex items-baseline gap-2">
            <a
              href={getRelativeLocaleUrl(locale, `/${category}/${topic}`)}
              class="nav-link text-sm"
            >
              {getTopicName(locale, topic)}
            </a>
            <span class="text-xs text-text-subtle">
              ({topicCourses.length} {topicCourses.length === 1 ? t(locale, 'course') : t(locale, 'courses')})
            </span>
          </li>
        ))}
      </ul>
    </section>
  </div>
</BaseLayout>
