---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { getRelativeLocaleUrl } from 'astro:i18n';
import { t, getCategoryName, getTopicName } from '../../../i18n/translations';

export async function getStaticPaths() {
  const courses = await getCollection('courses');

  const categories = new Map<string, Map<string, string[]>>();

  for (const course of courses) {
    const parts = course.id.split('/');
    if (parts.length < 4) continue;

    const [category, topic, courseSlug] = parts;

    if (!categories.has(category)) {
      categories.set(category, new Map());
    }
    const categoryTopics = categories.get(category)!;

    if (!categoryTopics.has(topic)) {
      categoryTopics.set(topic, []);
    }
    const topicCourses = categoryTopics.get(topic)!;

    if (!topicCourses.includes(courseSlug)) {
      topicCourses.push(courseSlug);
    }
  }

  const paths = [];
  for (const locale of ['en', 'fr', 'es']) {
    for (const [category, topics] of categories.entries()) {
      paths.push({
        params: { locale, category },
        props: { category, topics },
      });
    }
  }

  return paths;
}

interface Props {
  category: string;
  topics: Map<string, string[]>;
}

const { locale } = Astro.params;
const { category, topics } = Astro.props;
const categoryName = getCategoryName(locale, category);
---

<BaseLayout title={categoryName}>
  <h1>{categoryName}</h1>

  <p><a href={getRelativeLocaleUrl(locale, '/')}>{t(locale, 'backToHome')}</a></p>

  <h2>{t(locale, 'topics')}</h2>
  <ul>
    {Array.from(topics.entries()).map(([topic, topicCourses]) => (
      <li>
        <a href={getRelativeLocaleUrl(locale, `/${category}/${topic}`)}>{getTopicName(locale, topic)}</a>
        <span> ({topicCourses.length} {topicCourses.length === 1 ? t(locale, 'course') : t(locale, 'courses')})</span>
      </li>
    ))}
  </ul>
</BaseLayout>
