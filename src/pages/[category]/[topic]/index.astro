---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const courses = await getCollection('courses');

  const topics = new Map<string, { category: string; topic: string; courses: Array<{ slug: string; title: string }> }>();

  for (const course of courses) {
    const parts = course.id.split('/');
    if (parts.length < 4) continue;

    const [category, topic, courseSlug, locale] = parts;

    // Only use English courses for the listing
    if (locale !== 'en') continue;

    const key = `${category}/${topic}`;

    if (!topics.has(key)) {
      topics.set(key, { category, topic, courses: [] });
    }

    const topicData = topics.get(key)!;
    topicData.courses.push({ slug: courseSlug, title: course.data.title });
  }

  return Array.from(topics.values()).map(({ category, topic, courses }) => ({
    params: { category, topic },
    props: { category, topic, courses },
  }));
}

interface Props {
  category: string;
  topic: string;
  courses: Array<{ slug: string; title: string }>;
}

const { category, topic, courses } = Astro.props;
---

<BaseLayout title={topic}>
  <h1>{topic}</h1>

  <p><a href={`/${category}`}>‚Üê Back to {category}</a></p>

  <h2>Courses</h2>
  <ul>
    {courses.map((course) => (
      <li>
        <a href={`/${category}/${topic}/${course.slug}`}>{course.title}</a>
      </li>
    ))}
  </ul>
</BaseLayout>
